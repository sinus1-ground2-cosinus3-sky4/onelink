import{Fragment as Q,computed as C,defineComponent as F,h as J,inject as X,nextTick as L,onMounted as $,onUnmounted as Y,provide as Z,ref as w,toRaw as m,watch as U,watchEffect as _}from"vue";import{Features as K,render as j,omit as W,compact as z}from'../../utils/render.js';import{useId as N}from'../../hooks/use-id.js';import{Keys as V}from'../../keyboard.js';import{calculateActiveIndex as ee,Focus as R}from'../../utils/calculate-active-index.js';import{dom as y}from'../../utils/dom.js';import{useOpenClosed as te,State as q,useOpenClosedProvider as oe}from'../../internal/open-closed.js';import{match as E}from'../../utils/match.js';import{useResolveButtonType as le}from'../../hooks/use-resolve-button-type.js';import{useTreeWalker as ne}from'../../hooks/use-tree-walker.js';import{sortByDomNode as ae}from'../../utils/focus-management.js';import{useOutsideClick as ie}from'../../hooks/use-outside-click.js';import{Hidden as ue,Features as re}from'../../internal/hidden.js';import{objectToFormEntries as se}from'../../utils/form.js';import{useControllable as de}from'../../hooks/use-controllable.js';import{useTrackedPointer as pe}from'../../hooks/use-tracked-pointer.js';function fe(l,O){return l===O}var be=(r=>(r[r.Open=0]="Open",r[r.Closed=1]="Closed",r))(be||{}),ve=(r=>(r[r.Single=0]="Single",r[r.Multi=1]="Multi",r))(ve||{}),ce=(r=>(r[r.Pointer=0]="Pointer",r[r.Other=1]="Other",r))(ce||{});let G=Symbol("ComboboxContext");function B(l){let O=X(G,null);if(O===null){let r=new Error(`<${l} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(r,B),r}return O}let je=F({name:"Combobox",emits:{"update:modelValue":l=>!0},props:{as:{type:[Object,String],default:"template"},disabled:{type:[Boolean],default:!1},by:{type:[String,Function],default:()=>fe},modelValue:{type:[Object,String,Number,Boolean],default:void 0},defaultValue:{type:[Object,String,Number,Boolean],default:void 0},name:{type:String},nullable:{type:Boolean,default:!1},multiple:{type:[Boolean],default:!1}},inheritAttrs:!1,setup(l,{slots:O,attrs:r,emit:I}){let e=w(1),t=w(null),p=w(null),h=w(null),s=w(null),b=w({static:!1,hold:!1}),x=w([]),S=w(null),g=w(1),T=w(!1);function A(n=a=>a){let a=S.value!==null?x.value[S.value]:null,u=ae(n(x.value.slice()),f=>y(f.dataRef.domRef)),i=a?u.indexOf(a):null;return i===-1&&(i=null),{options:u,activeOptionIndex:i}}let M=C(()=>l.multiple?1:0),o=C(()=>l.nullable),[v,c]=de(C(()=>l.modelValue===void 0?E(M.value,{[1]:[],[0]:void 0}):l.modelValue),n=>I("update:modelValue",n),C(()=>l.defaultValue)),d={comboboxState:e,value:v,mode:M,compare(n,a){if(typeof l.by=="string"){let u=l.by;return(n==null?void 0:n[u])===(a==null?void 0:a[u])}return l.by(n,a)},defaultValue:C(()=>l.defaultValue),nullable:o,inputRef:p,labelRef:t,buttonRef:h,optionsRef:s,disabled:C(()=>l.disabled),options:x,change(n){c(n)},activeOptionIndex:C(()=>{if(T.value&&S.value===null&&x.value.length>0){let n=x.value.findIndex(a=>!a.dataRef.disabled);if(n!==-1)return n}return S.value}),activationTrigger:g,optionsPropsRef:b,closeCombobox(){T.value=!1,!l.disabled&&e.value!==1&&(e.value=1,S.value=null)},openCombobox(){if(T.value=!0,l.disabled||e.value===0)return;let n=x.value.findIndex(a=>{let u=m(a.dataRef.value);return E(M.value,{[0]:()=>d.compare(m(d.value.value),m(u)),[1]:()=>m(d.value.value).some(f=>d.compare(m(f),m(u)))})});n!==-1&&(S.value=n),e.value=0},goToOption(n,a,u){if(T.value=!1,l.disabled||s.value&&!b.value.static&&e.value===1)return;let i=A();if(i.activeOptionIndex===null){let P=i.options.findIndex(H=>!H.dataRef.disabled);P!==-1&&(i.activeOptionIndex=P)}let f=ee(n===R.Specific?{focus:R.Specific,id:a}:{focus:n},{resolveItems:()=>i.options,resolveActiveIndex:()=>i.activeOptionIndex,resolveId:P=>P.id,resolveDisabled:P=>P.dataRef.disabled});S.value=f,g.value=u!=null?u:1,x.value=i.options},selectOption(n){let a=x.value.find(i=>i.id===n);if(!a)return;let{dataRef:u}=a;c(E(M.value,{[0]:()=>u.value,[1]:()=>{let i=m(d.value.value).slice(),f=m(u.value),P=i.findIndex(H=>d.compare(f,m(H)));return P===-1?i.push(f):i.splice(P,1),i}}))},selectActiveOption(){if(d.activeOptionIndex.value===null)return;let{dataRef:n,id:a}=x.value[d.activeOptionIndex.value];c(E(M.value,{[0]:()=>n.value,[1]:()=>{let u=m(d.value.value).slice(),i=m(n.value),f=u.findIndex(P=>d.compare(i,m(P)));return f===-1?u.push(i):u.splice(f,1),u}})),d.goToOption(R.Specific,a)},registerOption(n,a){let u={id:n,dataRef:a},i=A(f=>[...f,u]);if(S.value===null){let f=a.value.value;E(M.value,{[0]:()=>d.compare(m(d.value.value),m(f)),[1]:()=>m(d.value.value).some(H=>d.compare(m(H),m(f)))})&&(i.activeOptionIndex=i.options.indexOf(u))}x.value=i.options,S.value=i.activeOptionIndex,g.value=1},unregisterOption(n){let a=A(u=>{let i=u.findIndex(f=>f.id===n);return i!==-1&&u.splice(i,1),u});x.value=a.options,S.value=a.activeOptionIndex,g.value=1}};ie([p,h,s],()=>d.closeCombobox(),C(()=>e.value===0)),Z(G,d),oe(C(()=>E(e.value,{[0]:q.Open,[1]:q.Closed})));let D=C(()=>d.activeOptionIndex.value===null?null:x.value[d.activeOptionIndex.value].dataRef.value),k=C(()=>{var n;return(n=y(p))==null?void 0:n.closest("form")});return $(()=>{U([k],()=>{if(!k.value||l.defaultValue===void 0)return;function n(){d.change(l.defaultValue)}return k.value.addEventListener("reset",n),()=>{var a;(a=k.value)==null||a.removeEventListener("reset",n)}},{immediate:!0})}),()=>{let{name:n,disabled:a,...u}=l,i={open:e.value===0,disabled:a,activeIndex:d.activeOptionIndex.value,activeOption:D.value,value:v.value};return J(Q,[...n!=null&&v.value!=null?se({[n]:v.value}).map(([f,P])=>J(ue,z({features:re.Hidden,key:f,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:f,value:P}))):[],j({theirProps:{...r,...W(u,["modelValue","defaultValue","nullable","multiple","onUpdate:modelValue","by"])},ourProps:{},slot:i,slots:O,attrs:r,name:"Combobox"})])}}}),Be=F({name:"ComboboxLabel",props:{as:{type:[Object,String],default:"label"},id:{type:String,default:()=>`headlessui-combobox-label-${N()}`}},setup(l,{attrs:O,slots:r}){let I=B("ComboboxLabel");function e(){var t;(t=y(I.inputRef))==null||t.focus({preventScroll:!0})}return()=>{let t={open:I.comboboxState.value===0,disabled:I.disabled.value},{id:p,...h}=l,s={id:p,ref:I.labelRef,onClick:e};return j({ourProps:s,theirProps:h,slot:t,attrs:O,slots:r,name:"ComboboxLabel"})}}}),He=F({name:"ComboboxButton",props:{as:{type:[Object,String],default:"button"},id:{type:String,default:()=>`headlessui-combobox-button-${N()}`}},setup(l,{attrs:O,slots:r,expose:I}){let e=B("ComboboxButton");I({el:e.buttonRef,$el:e.buttonRef});function t(s){e.disabled.value||(e.comboboxState.value===0?e.closeCombobox():(s.preventDefault(),e.openCombobox()),L(()=>{var b;return(b=y(e.inputRef))==null?void 0:b.focus({preventScroll:!0})}))}function p(s){switch(s.key){case V.ArrowDown:s.preventDefault(),s.stopPropagation(),e.comboboxState.value===1&&e.openCombobox(),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.ArrowUp:s.preventDefault(),s.stopPropagation(),e.comboboxState.value===1&&(e.openCombobox(),L(()=>{e.value.value||e.goToOption(R.Last)})),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return;case V.Escape:if(e.comboboxState.value!==0)return;s.preventDefault(),e.optionsRef.value&&!e.optionsPropsRef.value.static&&s.stopPropagation(),e.closeCombobox(),L(()=>{var b;return(b=e.inputRef.value)==null?void 0:b.focus({preventScroll:!0})});return}}let h=le(C(()=>({as:l.as,type:O.type})),e.buttonRef);return()=>{var g,T;let s={open:e.comboboxState.value===0,disabled:e.disabled.value,value:e.value.value},{id:b,...x}=l,S={ref:e.buttonRef,id:b,type:h.value,tabindex:"-1","aria-haspopup":"listbox","aria-controls":(g=y(e.optionsRef))==null?void 0:g.id,"aria-expanded":e.disabled.value?void 0:e.comboboxState.value===0,"aria-labelledby":e.labelRef.value?[(T=y(e.labelRef))==null?void 0:T.id,b].join(" "):void 0,disabled:e.disabled.value===!0?!0:void 0,onKeydown:p,onClick:t};return j({ourProps:S,theirProps:x,slot:s,attrs:O,slots:r,name:"ComboboxButton"})}}}),Ne=F({name:"ComboboxInput",props:{as:{type:[Object,String],default:"input"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},displayValue:{type:Function},defaultValue:{type:String,default:void 0},id:{type:String,default:()=>`headlessui-combobox-input-${N()}`}},emits:{change:l=>!0},setup(l,{emit:O,attrs:r,slots:I,expose:e}){let t=B("ComboboxInput"),p={value:!1};e({el:t.inputRef,$el:t.inputRef});let h=C(()=>{var v;let o=t.value.value;return y(t.inputRef)?typeof l.displayValue!="undefined"&&o!==void 0?(v=l.displayValue(o))!=null?v:"":typeof o=="string"?o:"":""});$(()=>{U([h,t.comboboxState],([o,v],[c,d])=>{if(p.value)return;let D=y(t.inputRef);!D||(d===0&&v===1||o!==c)&&(D.value=o)},{immediate:!0}),U([t.comboboxState],([o],[v])=>{if(o===0&&v===1){let c=y(t.inputRef);if(!c)return;let d=c.value,{selectionStart:D,selectionEnd:k,selectionDirection:n}=c;c.value="",c.value=d,n!==null?c.setSelectionRange(D,k,n):c.setSelectionRange(D,k)}})});let s=w(!1);function b(){s.value=!0}function x(){setTimeout(()=>{s.value=!1})}function S(o){switch(p.value=!0,o.key){case V.Backspace:case V.Delete:if(t.mode.value!==0||!t.nullable.value)return;let v=o.currentTarget;requestAnimationFrame(()=>{if(v.value===""){t.change(null);let c=y(t.optionsRef);c&&(c.scrollTop=0),t.goToOption(R.Nothing)}});break;case V.Enter:if(p.value=!1,t.comboboxState.value!==0||s.value)return;if(o.preventDefault(),o.stopPropagation(),t.activeOptionIndex.value===null){t.closeCombobox();return}t.selectActiveOption(),t.mode.value===0&&t.closeCombobox();break;case V.ArrowDown:return p.value=!1,o.preventDefault(),o.stopPropagation(),E(t.comboboxState.value,{[0]:()=>t.goToOption(R.Next),[1]:()=>t.openCombobox()});case V.ArrowUp:return p.value=!1,o.preventDefault(),o.stopPropagation(),E(t.comboboxState.value,{[0]:()=>t.goToOption(R.Previous),[1]:()=>{t.openCombobox(),L(()=>{t.value.value||t.goToOption(R.Last)})}});case V.Home:if(o.shiftKey)break;return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(R.First);case V.PageUp:return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(R.First);case V.End:if(o.shiftKey)break;return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(R.Last);case V.PageDown:return p.value=!1,o.preventDefault(),o.stopPropagation(),t.goToOption(R.Last);case V.Escape:if(p.value=!1,t.comboboxState.value!==0)return;o.preventDefault(),t.optionsRef.value&&!t.optionsPropsRef.value.static&&o.stopPropagation(),t.closeCombobox();break;case V.Tab:if(p.value=!1,t.comboboxState.value!==0)return;t.mode.value===0&&t.selectActiveOption(),t.closeCombobox();break}}function g(o){O("change",o)}function T(o){t.openCombobox(),O("change",o)}function A(){p.value=!1}let M=C(()=>{var o,v,c,d;return(d=(c=(v=l.defaultValue)!=null?v:t.defaultValue.value!==void 0?(o=l.displayValue)==null?void 0:o.call(l,t.defaultValue.value):null)!=null?c:t.defaultValue.value)!=null?d:""});return()=>{var k,n,a,u,i,f;let o={open:t.comboboxState.value===0},{id:v,displayValue:c,...d}=l,D={"aria-controls":(k=t.optionsRef.value)==null?void 0:k.id,"aria-expanded":t.disabled.value?void 0:t.comboboxState.value===0,"aria-activedescendant":t.activeOptionIndex.value===null||(n=t.options.value[t.activeOptionIndex.value])==null?void 0:n.id,"aria-multiselectable":t.mode.value===1?!0:void 0,"aria-labelledby":(i=(a=y(t.labelRef))==null?void 0:a.id)!=null?i:(u=y(t.buttonRef))==null?void 0:u.id,"aria-autocomplete":"list",id:v,onCompositionstart:b,onCompositionend:x,onKeydown:S,onChange:g,onInput:T,onBlur:A,role:"combobox",type:(f=r.type)!=null?f:"text",tabIndex:0,ref:t.inputRef,defaultValue:M.value};return j({ourProps:D,theirProps:d,slot:o,attrs:r,slots:I,features:K.RenderStrategy|K.Static,name:"ComboboxInput"})}}}),Ke=F({name:"ComboboxOptions",props:{as:{type:[Object,String],default:"ul"},static:{type:Boolean,default:!1},unmount:{type:Boolean,default:!0},hold:{type:[Boolean],default:!1}},setup(l,{attrs:O,slots:r,expose:I}){let e=B("ComboboxOptions"),t=`headlessui-combobox-options-${N()}`;I({el:e.optionsRef,$el:e.optionsRef}),_(()=>{e.optionsPropsRef.value.static=l.static}),_(()=>{e.optionsPropsRef.value.hold=l.hold});let p=te(),h=C(()=>p!==null?p.value===q.Open:e.comboboxState.value===0);return ne({container:C(()=>y(e.optionsRef)),enabled:C(()=>e.comboboxState.value===0),accept(s){return s.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:s.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(s){s.setAttribute("role","none")}}),()=>{var S,g,T;let s={open:e.comboboxState.value===0},b={"aria-labelledby":(T=(S=y(e.labelRef))==null?void 0:S.id)!=null?T:(g=y(e.buttonRef))==null?void 0:g.id,id:t,ref:e.optionsRef,role:"listbox"},x=W(l,["hold"]);return j({ourProps:b,theirProps:x,slot:s,attrs:O,slots:r,features:K.RenderStrategy|K.Static,visible:h.value,name:"ComboboxOptions"})}}}),$e=F({name:"ComboboxOption",props:{as:{type:[Object,String],default:"li"},value:{type:[Object,String,Number,Boolean]},disabled:{type:Boolean,default:!1}},setup(l,{slots:O,attrs:r,expose:I}){let e=B("ComboboxOption"),t=`headlessui-combobox-option-${N()}`,p=w(null);I({el:p,$el:p});let h=C(()=>e.activeOptionIndex.value!==null?e.options.value[e.activeOptionIndex.value].id===t:!1),s=C(()=>E(e.mode.value,{[0]:()=>e.compare(m(e.value.value),m(l.value)),[1]:()=>m(e.value.value).some(o=>e.compare(m(o),m(l.value)))})),b=C(()=>({disabled:l.disabled,value:l.value,domRef:p}));$(()=>e.registerOption(t,b)),Y(()=>e.unregisterOption(t)),_(()=>{e.comboboxState.value===0&&(!h.value||e.activationTrigger.value!==0&&L(()=>{var o,v;return(v=(o=y(p))==null?void 0:o.scrollIntoView)==null?void 0:v.call(o,{block:"nearest"})}))});function x(o){if(l.disabled)return o.preventDefault();e.selectOption(t),e.mode.value===0&&e.closeCombobox()}function S(){if(l.disabled)return e.goToOption(R.Nothing);e.goToOption(R.Specific,t)}let g=pe();function T(o){g.update(o)}function A(o){!g.wasMoved(o)||l.disabled||h.value||e.goToOption(R.Specific,t,0)}function M(o){!g.wasMoved(o)||l.disabled||!h.value||e.optionsPropsRef.value.hold||e.goToOption(R.Nothing)}return()=>{let{disabled:o}=l,v={active:h.value,selected:s.value,disabled:o},c={id:t,ref:p,role:"option",tabIndex:o===!0?void 0:-1,"aria-disabled":o===!0?!0:void 0,"aria-selected":s.value,disabled:void 0,onClick:x,onFocus:S,onPointerenter:T,onMouseenter:T,onPointermove:A,onMousemove:A,onPointerleave:M,onMouseleave:M};return j({ourProps:c,theirProps:l,slot:v,attrs:r,slots:O,name:"ComboboxOption"})}}});export{je as Combobox,He as ComboboxButton,Ne as ComboboxInput,Be as ComboboxLabel,$e as ComboboxOption,Ke as ComboboxOptions};
